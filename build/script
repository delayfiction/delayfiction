#!/usr/bin/env ruby

require 'fileutils'
require_relative 'post.rb'
require_relative 'issue.rb'
require_relative 'static.rb'

Dir.foreach(Dir.pwd + "/src/issues") do |y|
  if y[-3..-1] == ".md"
    q = y[0..-4]
    issue = Issue.new(Dir.pwd + "/src/issues/" + y)
    if Dir.exist?(issue.directory) == false
      FileUtils.mkdir(issue.directory)
    end
    includes = Array.new
    Dir.foreach(Dir.pwd + "/src/posts/" + q ) do |x|
      if x[-3..-1] == ".md"
        post = Post.new(Dir.pwd + "/src/posts/" + q + "/" + x)
        template = File.read(Dir.pwd + "/build/show-post.html.erb")
        post_address = post.issue_dir + x[0..-4] + '.html'
        includes.push(post_address)
        File.write(post_address, post.render(template))
      end
    end
    template = File.read(Dir.pwd + "/build/show-issue.html.erb")
    File.write(issue.directory + q + '.html', issue.render(template))
    puts includes
  end
end

Dir.foreach(Dir.pwd + "/src/static") do |z|
  if z[-3..-1] == ".md"
    static = Static.new(Dir.pwd + "/src/static/" + z)
    template = File.read(Dir.pwd + "/build/show-page.html.erb")
    File.write(Dir.pwd + "/" + z[0..-4] + '.html', static.render(template))
  end
end
